---
import Layout from '../layouts/Layout.astro';
import { sanityClient } from '../lib/sanity';
import { PortableText } from '@portabletext/react';

// Fetch bio data
const bio = await sanityClient.fetch(`*[_type == "bio"][0]{
  name,
  title,
  bio,
  email,
  linkedin,
  github,
  "photoUrl": photo.asset->url,
  "cvUrl": cv.asset->url
}`);

// Fetch papers organized by category
const paperCategories = ['working', 'progress', 'published', 'policy'];
const papersByCategory = {};

for (const category of paperCategories) {
  papersByCategory[category] = await sanityClient.fetch(
    `*[_type == "paper" && category == $category] | order(year desc){
      title,
      authors,
      year,
      journal,
      venue,
      volume,
      pages,
      number,
	  doi,
      status,
      abstract,
"pdfUrl": pdf.asset->url,
      links[]{text, 
	  url}
    }`,
    { category }
  );
}

const categoryLabels = {
  published: 'Published Papers',
  working: 'Working Papers',
  progress: 'Work in Progress',
  policy: 'Policy Work'
};
---

<Layout title={bio.name}>
  <header>
    <div class="container">
      <h1>{bio.name}</h1>
      <p class="subtitle">{bio.title}</p>
      
      <div class="contact-info">
        <a href={`mailto:${bio.email}`}>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="4" width="20" height="16" rx="2"/>
            <path d="M22 7l-10 7L2 7"/>
          </svg>
          {bio.email}
        </a>
        <span>•</span>
        {bio.cvUrl && (
          <>
            <a href={bio.cvUrl}>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <path d="M14 2v6h6"/>
                <path d="M12 18v-6"/>
                <path d="M9 15l3 3 3-3"/>
              </svg>
              CV
            </a>
            <span>•</span>
          </>
        )}
        {bio.linkedin && (
          <>
            <a href={bio.linkedin} target="_blank">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"/>
                <rect x="2" y="9" width="4" height="12"/>
                <circle cx="4" cy="4" r="2"/>
              </svg>
              LinkedIn
            </a>
            <span>•</span>
          </>
        )}
        {bio.github && (
          <a href={bio.github} target="_blank">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"/>
            </svg>
            GitHub
          </a>
        )}
      </div>
    </div>
  </header>

  <main class="container">
    <article>

      <!-- Add a visually hidden h1 for semantics -->
      <h1 class="visually-hidden">About Christian Johannes Meyer</h1>

      <!-- Bio Section with Photo -->
      <section aria-labelledby="about-heading">
        <h2 id="about-heading" class="visually-hidden">Biography</h2>
        <div class="bio-section">
          <div class="bio-text">
            {bio.bio.split('\n\n').map(paragraph => (
              <p set:html={paragraph} />
            ))}
          </div>
          
          {bio.photoUrl && (
            <img src={bio.photoUrl} alt={bio.name} class="bio-photo" />
          )}
        </div>
      </section>

      <!-- Research Section -->
      <section>
        <h2 id="research">Research</h2>
        
        {paperCategories.map(category => {
          const papers = papersByCategory[category];
          if (!papers || papers.length === 0) return null;
          
          return (
            <div class="paper-category">
              <h3>{categoryLabels[category]}</h3>
              <div class="papers">
                {papers.map(paper => (
                  <article class="paper">
                    <h4>{paper.title}</h4>
                    <p class="authors">{paper.authors}</p>
                    <p class="publication" set:html={(() => {
                      const parts = [];
                      
                      // Add journal/venue in italics
                      if (paper.journal) parts.push(`<em>${paper.journal}</em>`);
                      if (paper.venue) parts.push(`<em>${paper.venue}</em>`);
                      
                      // Add volume
                      if (paper.volume) parts.push(paper.volume);
                      
                      // Add pages
            if (paper.pages) parts.push(paper.pages);
                      
                      // Add paper number
                      if (paper.number) parts.push(`No. ${paper.number}`);
                      
                      // Add status in parentheses
                      if (paper.status) parts.push(`(${paper.status})`);
                      
                      // Add year (optional for work in progress)
                      if (paper.year) parts.push(paper.year.toString());
                      
                      // Add DOI
            if (paper.doi) {
            parts.push(`<a href="https://doi.org/${paper.doi}" target="_blank">doi:${paper.doi}</a>`);
            }
                      
                      // Join with commas and return (or return nothing if no parts)
                      return parts.length > 0 ? parts.join(', ') : '';
                    })()} />
                    
                    {paper.abstract && (
                      <details class="paper-details">
                        <summary>
                          <span class="summary-icon">+</span>
                          <span class="summary-text">Show abstract</span>
                        </summary>
                        <p class="abstract">{paper.abstract}</p>
                      </details>
                    )}
                    
                    <div class="paper-links">
                      {paper.pdfUrl && (
                        <a href={paper.pdfUrl} target="_blank" class="pdf-link">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <path d="M14 2v6h6"/>
                            <path d="M12 18v-6"/>
                            <path d="M9 15l3 3 3-3"/>
                          </svg>
                          PDF
                        </a>
                      )}
                      {paper.links && paper.links.length > 0 && paper.links.map((link, idx) => (
                      <a href={link.url} target="_blank" rel="noopener noreferrer">{link.text}</a>
                      ))}
                    </div>
                  </article>
                ))}
              </div>
            </div>
          );
        })}
      </section>
    </article>
  </main>


<script>
  // Toggle abstract summary text and icon
  document.addEventListener('DOMContentLoaded', () => {
    const details = document.querySelectorAll('.paper-details');
    
    details.forEach(detail => {
      detail.addEventListener('toggle', () => {
        const summary = detail.querySelector('summary');
        const icon = summary.querySelector('.summary-icon');
        const text = summary.querySelector('.summary-text');
        
        if (detail.open) {
          icon.textContent = '−';
          text.textContent = 'Hide abstract';
        } else {
          icon.textContent = '+';
          text.textContent = 'Show abstract';
        }
      });
    });
  });
</script>

 <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "Person",
    "name": bio.name,
    "jobTitle": "Director of the Oxford Martin Programme on the Future of Development",
    "affiliation": {
      "@type": "Organization",
      "name": "University of Oxford"
    },
    "url": "https://www.chrmeyer.com",
    "email": bio.email,
    "image": bio.photoUrl,
    "sameAs": [
      bio.linkedin,
      bio.github
    ],
    "alumniOf": {
      "@type": "Organization",
      "name": "University of Oxford"
    },
    "knowsAbout": [
      "Development Economics",
      "Labor Economics",
      "Behavioral Economics",
      "Field Experiments"
    ]
  })} />

</Layout>
